# Contributing to Classmoji

Thanks for your interest in contributing to Classmoji! This guide will help you get set up and start contributing.

## Code of Conduct

This project follows the [Contributor Covenant Code of Conduct](CODE_OF_CONDUCT.MD). By participating, you agree to uphold this code. Please report unacceptable behavior to **hello@classmoji.io**.

## Contributor License Agreement (CLA)

Before your first pull request can be merged, you'll need to agree to our [Contributor License Agreement](CLA.md). This is handled automatically via [CLA Assistant](https://github.com/cla-assistant/cla-assistant) — you'll be prompted to sign when you open your first PR.

## Getting Started

### Prerequisites

- **Node.js 22+** and **npm 10+**
- **Docker** (for the local PostgreSQL database)
- **Git** (with submodule support)

### Clone the Repository

```bash
git clone https://github.com/classmoji/classmoji-apps.git
cd classmoji-apps
```

> **Note:** The `apps/ai-agent` directory is a private git submodule and will be empty for open-source contributors. This is expected — the AI agent features will simply be disabled, and the rest of the platform works without it.

### Install Dependencies

```bash
npm install
```

### Set Up the Database

Start the PostgreSQL container:

```bash
npm run db:start
```

This runs a Postgres 16 instance on **port 5433** with default credentials (`classmoji`/`classmoji`).

### Configure Environment Variables

Create a `.env` file at the project root:

```bash
cp .env.example .env  # if available, or create manually
```

At minimum, your `.env` needs:

```env
# Database (matches docker-compose defaults)
DATABASE_URL="postgresql://classmoji:classmoji@localhost:5433/classmoji"

# Auth (generate your own secret — any random string works for local dev)
BETTER_AUTH_SECRET="your-random-secret-string-here"
BETTER_AUTH_URL="http://localhost:3000"

# GitHub App OAuth (required for login — see note below)
CLIENT_ID=""
CLIENT_SECRET=""

# App URLs
HOST_URL="http://localhost:3000"
WEBAPP_URL="http://localhost:3000"
SLIDES_URL="http://localhost:3001"
```

> **GitHub OAuth:** To test login locally, you'll need to [create a GitHub OAuth App](https://docs.github.com/en/apps/oauth-apps/building-oauth-apps/creating-an-oauth-app) with the callback URL `http://localhost:3000/api/auth/callback/github`, then add the Client ID and Secret to your `.env`. For non-auth work, you can skip this — most UI and backend changes can be tested without logging in.

### Run Database Migrations and Seed

```bash
DATABASE_URL="postgresql://classmoji:classmoji@localhost:5433/classmoji" npx prisma migrate deploy --schema packages/database/schema.prisma
DATABASE_URL="postgresql://classmoji:classmoji@localhost:5433/classmoji" npx prisma generate --schema packages/database/schema.prisma
```

To seed the database with sample data:

```bash
DATABASE_URL="postgresql://classmoji:classmoji@localhost:5433/classmoji" node packages/database/scripts/seed.js
```

### Start the Dev Server

```bash
npm run dev
```

The webapp will be available at **http://localhost:3000** and slides at **http://localhost:3001**.

## Finding Work

### GitHub Issues

We use [GitHub Issues](https://github.com/classmoji/classmoji-apps/issues) to track bugs, feature requests, and tasks. Look for issues labeled:

- **`good first issue`** — Great starting points for new contributors
- **`help wanted`** — We'd especially appreciate community help here
- **`bug`** — Something isn't working correctly
- **`enhancement`** — New features or improvements

### GitHub Projects

Our [GitHub Project board](https://github.com/orgs/classmoji/projects) shows the current roadmap and priorities. Check there to see what's in progress and what's up next.

### Claiming Work

Comment on an issue to let us know you're working on it. If an issue is already assigned, check in with the assignee before starting your own implementation.

## Making Changes

### Branch Workflow

Always work in a **feature branch** — never commit directly to `main` or `staging`.

```bash
git checkout -b your-feature-name
```

### Code Style

- **JavaScript/TypeScript** with ES Modules
- **2-space indentation**, semicolons, single quotes
- **React components:** PascalCase filenames (e.g., `GradesTable.jsx`)
- **Hooks/utilities:** camelCase filenames
- **Route files:** `apps/webapp/app/routes/<route>/route.jsx`
- **Styling:** TailwindCSS with `dark:` variants for dark mode support
- **Dark mode is required:** All UI changes must include both light and dark mode styles

### Testing

We use [Playwright](https://playwright.dev/) for end-to-end tests:

```bash
# Run all webapp tests
DATABASE_URL="postgresql://classmoji:classmoji@localhost:5433/classmoji" npx turbo run web:test --filter=@classmoji/web

# Run slides tests
DATABASE_URL="postgresql://classmoji:classmoji@localhost:5433/classmoji" npx turbo run test --filter=@classmoji/slides
```

Test specs live in:

- `apps/webapp/tests/**/*.spec.{ts,js}`
- `apps/slides/tests/**/*.spec.ts`

Please add tests for new features and ensure existing tests pass before submitting a PR.

### Authorization

**All routes must be protected** unless explicitly public. Every new loader/action needs an auth check. See `apps/webapp/app/utils/routeAuth.server.js` for the available auth helpers:

- `requireClassroomAdmin()` — admin-only routes
- `requireClassroomTeachingTeam()` — staff routes (admins + assistants)
- `requireStudentAccess()` — student-only routes
- `assertClassroomAccess({...})` — custom role/ownership checks

## Submitting a Pull Request

1. **Push your branch** to your fork (or the repo if you have write access)
2. **Open a pull request** against the `main` branch
3. **Fill in the PR template** with:
   - A description of what changed and why
   - Linked issues (e.g., `Fixes #123`)
   - Screenshots for any UI changes (light **and** dark mode)
   - Steps to test your changes
4. **Sign the CLA** if prompted (first-time contributors only)
5. **Address review feedback** — we aim to review PRs promptly

### Commit Messages

We follow [Conventional Commits](https://www.conventionalcommits.org/) format for clear, consistent commit history.

**Using the Interactive Helper (Recommended for First-Timers):**

```bash
npm run commit
```

This launches an interactive CLI that guides you through creating a properly formatted commit:
- Choose the type (feat, fix, docs, etc.)
- Optionally specify a scope (webapp, slides, etc.)
- Write a clear description
- Add details if needed

**Manual Commit Format:**

If you prefer writing commits manually:

```
type(scope): short description

[optional body]
```

**Examples:**
```
feat(webapp): add grade export button
fix(slides): correct theme switching in fullscreen
docs: update contributing guide
refactor(services): simplify quiz scoring logic
```

**Common types:**
- `feat` — New feature
- `fix` — Bug fix
- `docs` — Documentation changes
- `refactor` — Code refactoring
- `test` — Adding tests
- `chore` — Build/tooling changes

### PR Size

Keep pull requests focused and incremental. A PR that does one thing well is much easier to review than one that touches 30 files. If your change is large, consider splitting it into a stack of smaller PRs.

## Project Structure

```
classmoji-apps/
  apps/
    webapp/        # Main React Router app (routes, components, styles)
    slides/        # Slide presentation app with Reveal.js
    ai-agent/      # Private submodule — AI features (empty for OSS)
    hook-station/  # Webhook listener (GitHub/Stripe)
    site/          # Astro marketing site
  packages/
    database/      # Prisma schema, migrations, seeds
    services/      # Shared business logic
    utils/         # Shared helpers
    auth/          # Authentication utilities
    content/       # Content management utilities
    ui-components/ # Shared React UI components
    tasks/         # Trigger.dev workflows
```

## What's Off-Limits

The **`apps/ai-agent`** directory is a private, proprietary submodule and is **not** covered by the AGPL-3.0 license. It will appear as an empty directory for OSS contributors. Please do not attempt to reverse-engineer or recreate its functionality. The rest of the codebase will gracefully disable AI features when the agent is unavailable.

## Getting Help

- **Open an issue** for bugs or questions
- **Start a discussion** for feature ideas or architectural questions
- Check existing issues and PRs before creating new ones

## License

By contributing to Classmoji, you agree that your contributions will be licensed under the [GNU Affero General Public License v3.0 or later](LICENSE). See the [CLA](CLA.md) for details on the rights you grant.
